// Web-Based Inventory Management System - Database Schema
// Use PostgreSQL for Supabase (or any Postgres). For local SQLite, switch provider to "sqlite" and use file:./dev.db

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique // OWNER, ADMIN, CASHIER, CUSTOMER
  description String?
  users       User[]
}

// Auth/RBAC: id, name (fullName), email, password (passwordHash), role (via Role), status (isActive), created_at (createdAt). Inactive users cannot log in.
model User {
  id                  Int                 @id @default(autoincrement())
  email               String              @unique
  passwordHash        String
  fullName            String
  contactNumber       String?
  profilePictureUrl   String?
  roleId              Int
  role                Role                @relation(fields: [roleId], references: [id])
  isActive            Boolean             @default(true)
  lastLoginAt         DateTime?
  forcePasswordChange Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  sales               SaleTransaction[]
  orders              OnlineOrder[]
  notifications       Notification[]
  inventoryMovements  InventoryMovement[]
}

model Product {
  id                  Int                  @id @default(autoincrement())
  name                String
  sku                 String?              @unique
  category            String?
  description         String?
  specifications      String? // JSON string for key-value specs
  unitPrice           Float
  imageUrl            String? // stored path e.g. /api/uploads/products/xxx.jpg
  status              String               @default("active") // active | inactive
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  inventory           Inventory?
  saleItems           SaleItem[]
  orderItems          OrderItem[]
  aiPredictions       AiPrediction[]
  inventoryMovements  InventoryMovement[]
  notifications       Notification[]
  productRiskSnapshot ProductRiskSnapshot?

  @@index([name])
  @@index([category])
  @@index([status])
}

model Inventory {
  id                Int      @id @default(autoincrement())
  productId         Int      @unique
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity          Int      @default(0)
  lowStockThreshold Int      @default(10) // Minimum stock threshold (warning/reorder level)
  reorderLevel      Int      @default(10) // When qty <= this, show Low Stock
  reorderQuantity   Int      @default(100) // Suggested order quantity; qty > this = overstocked
  updatedAt         DateTime @updatedAt
}

model InventoryMovement {
  id        Int      @id @default(autoincrement())
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  type      String // STOCK_IN, STOCK_OUT, ADJUSTMENT
  quantity  Int // positive for IN, negative for OUT
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  notes     String?
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])
}

model SaleTransaction {
  id        Int        @id @default(autoincrement())
  userId    Int
  user      User       @relation(fields: [userId], references: [id])
  total     Float
  createdAt DateTime   @default(now())
  items     SaleItem[]
}

model SaleItem {
  id        Int             @id @default(autoincrement())
  saleId    Int
  sale      SaleTransaction @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId Int
  product   Product         @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Float
  subtotal  Float
}

model OnlineOrder {
  id            Int         @id @default(autoincrement())
  userId        Int
  user          User        @relation(fields: [userId], references: [id])
  status        String // PENDING_APPROVAL, APPROVED, REJECTED
  total         Float
  paymentMethod String? // GCASH, DEBIT_CARD, CASH_ON_DELIVERY
  // Shipping address (collected at checkout)
  streetAddress String?
  barangay      String?
  city          String?
  province      String?
  zipCode       String?
  landmark      String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  items         OrderItem[]
}

model OrderItem {
  id        Int         @id @default(autoincrement())
  orderId   Int
  order     OnlineOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId Int
  product   Product     @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Float
  subtotal  Float
}

model AiPrediction {
  id               Int      @id @default(autoincrement())
  productId        Int
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  predictedDemand  Float
  suggestedRestock Int
  riskOfStockout   String? // LOW, MEDIUM, HIGH
  generatedAt      DateTime @default(now())
  periodStart      DateTime
  periodEnd        DateTime
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String // Critical, Low, Overstock, NoData, OutOfStock, ORDER_APPROVED, LOW_STOCK, etc.
  riskLevel String? // Critical, Low, Safe, No Data, Out of Stock, Overstock
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([createdAt])
  @@index([type, read])
}

model ProductRiskSnapshot {
  id        Int      @id @default(autoincrement())
  productId Int      @unique
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  riskLevel String
  updatedAt DateTime @updatedAt
}

model SystemConfig {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String
}
